InnoDB 스토리지 엔진의 주요 특징들과 함께 하나씩 살펴보자.

# 이노DB 스토리지 엔진 아키텍처

InnoDB 스토리지 엔진은 MySQL 스토리지 엔진 중 가장 많이 사용되는 스토리지 엔진이다.

InnoDB는 레코드 기반의 잠금을 제공하며, 덕분에 높은 동시성 처리가 가능하고 안정적이며 성능이 뛰어나다.

## 프라이머리 키에 의한 클러스터링

InnoDB의 모든 테이블은 기본적으로 프라이머리 키를 기준으로 클러스터링되어 저장된다. 즉, 프라 이머리 키 값의 순서대로 디스크에 저장된다는 뜻

모든 세컨더리 인덱스는 레코드의 주소 대신 프라이머리 키의 값을 논리적인 주소로 사용한다.

## 외래 키 지원

외래 키에 대한 지원은 InnoDB 스토리지 엔진 레벨에서 지원하는 기능이다.

InnoDB 외래 키는 부모 테이블과 자식 테이블 모두 해당 컬럼에 인덱스 생성이 필요하고, 변경 시 참조된 테이블에 데이터가 존재하는지 체크해야 한다.

## MVCC(****다중 버전 동시성 제어)****

일반적으로 레코드 레벨의 트랜잭션을 지원하는 DBMS가 제공하는 기능이며, MVCC의 가장 큰 목 적은 잠금을 사용하지 않는 일관된 읽기를 제공하는 데 있다.

InnoDB는 언두 로그(Undo log)를 이 용해 이 기능을 구현한다. 

동시 접근을 허용하는 데이터베이스에서 동시성을 제어하기 위해 사용하는 방법 중 하나이다.

[DBMS concurrency control 기초(transaction schedules)](https://velog.io/@leekhy02/DBMS-concurrency-control-기초transaction-schedules)

## 잠금 없는 일관된  읽기

InnoDB 스토리지 엔진은 MVCC 기술을 사용해 잠금을 걸지 않고 일기 작업을 수행하기 때문에 읽기 작업은 다른 트랜잭션이 가지고 있는 잠금을 기다리지 않고 바로 가능하다.

이러한 특징 때문에 UPDATE인 상태의 레코드를 다른 사용자가 SELECT 하더라도 이 UPDATE 트랜잭션이 SELECT 작업을 방해하지 않는다. 이를 잠금 없는 일관된 읽기라고 한다.(격리 수준이 SERIALIZABLE의 경우에는 순수한 읽기 작업의 경우에도 락을 필요로 한다.)

## 동시성 제어가 필요한 이유는?

다중 사용자 환경을 지원하는 DBMS의 경우, 반드시 지원해야 하는 기능이고,

다중 사용자 환경에서 둘 이상의 트랜잭션이 동시에 수행될 때, 일관성을 해치지 않도록 트랜잭션의 데이터를 접근 제어 해야합니다.

## 자동데드락감지

InnoDB 스토리지 엔진은 내부적으로 잠금이 교착 상태에 빠지지 않았는지 체크하기 위해 잠금 대기 목록을 그래프 형태로 관리한다.

InnoDB 스토리지 엔진은 데드락 감지 스레드를 가지 고 있어서 데드락 감지 스레드가 주기적으로 잠금 대기 그래프를 검사해 교착 상태에 빠진 트랜잭션들 을 찾아서 그중 하나를 강제 종료한다. 이때 어느 트랜잭션을 먼저 강제 종료할 것인지를 판단하는 기 준은 트랜잭션의 언두 로그 양이며, 언두 로그 레코드를 더 적게 가진 트랜잭션이 일반적으로 롤백의 대상이 된다.

동시 처리 스레드가 매우 많을 경우 데드락 감지 스레드는 더 많은 CPU 자원을 소모할 수도 있다.

## 자동화된 장애 복구

InnoDB에는 손실이나 장애로부터 데이터를 보호하기 위해 MySQL 서버가 시작될 때 완료되지 못한 트랜잭션이나 디스크에 일부만 기록된 데이터에 대한 복구 작업이 자동으로 진행된다.

## InnoDB 버퍼 풀

InnoDB 스토리지 엔진에서 가장 핵심적인 부분으로, 디스크의 데이터 파일이나 인덱스 정보를 메모리에 캐시해 두는 공간이다.

쓰기 작업을 지연시켜 일괄 작업을 처리할 수 있게 해주는 버퍼 역할도 한다.

InnoDB 버퍼 풀의 크기를 적절히 작은 값으로 설정해 조금씩 증가시키는 방법을 사용하는 것이 좋다

## 언두로그

InnoDB는 트랜잭션과 격리 수준을 보장하기 위해 DML로 변경되기 이전 버전의 데이터를 별도로 백업. 이렇게 백업된 데이터를 언두로그라고 한다.

언두로그는 데이터의 복구를 통해 트랜잭션을 보장하고, 격리 수준에 맞게 변경 중인 레코드가 아닌 언두로그에 백업해둔 데이터를 조회함으로서 격리 수준을 보장한다.

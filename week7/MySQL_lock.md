# MySQL 엔진의 잠금

MySQL의 잠금은 크게 MySQL 엔진 잠금과 스토리지 엔진 잠금으로 나눌 수 있습니다.
MySQL 엔진 레벨의 잠금은 모든 스토리지 엔진에 영향을 미치지만, 스토리지 엔진 레벨의 잠금은 상호간 영향을 미치지는 않습니다.

MySQL 엔진에서는 크게 다음과 같은 락을 사용합니다.

- 글로벌 락
- 테이블 락
- 네임드 락
- 메타데이터 락

## 글로벌 락 (GLOBAL LOCK)

글로벌 락은 MySQL에서 제공하는 잠금 가운데 가장 범위가 큽니다.
한 세션에서 글로벌 락을 획득하면 다른 세션에서 `SELECT`를 제외한 대부분의 DDL, DML 문장을 실행하는 경우 글로벌 락이 해제될 때까지 대기 상태로 남아있어야 합니다.

이와 같이 글로벌 락을 사용하게 되면 MySQL 서버의 모든 변경 작업은 멈추게 됩니다.
하지만 MySQL에서는 스토리지 엔진의 사용이 일반화 되었기 때문에 모든 데이터 변경 작업을 멈출 필요가 없어졌습니다. (InnoDB의 경우 트랜잭션을 지원하기 떄문에)
MySQL 8.0부터 InnoDB가 기본 스토리지 엔진으로 채택되었기 때문에 조금 더 가벼운 글로벌 락의 필요성이 생겼는데, MySQL 8.0 버전부터는 백업 툴들의 백업 락이 도입되었습니다.

백업락은 레플리카 서버에서 백업 도중 글로벌 락으로 인해 백업이 실패하는 경우, 처음부터 다시 백업을 실행해야하는 문제를 해결하기 위해 등장했습니다.

### Replica server?

처음에는 단일 Application server와 DB가 존재했지만 사용자가 점점 많아지며 DB는 많은 쿼리를 처리하기에 힘든 상황에 직면하게 됩니다. 즉, DB 서버의 부하로 인하여 클라이언트 입장에서는 응답을 느리게 받는 것이죠.

DB를 이중화하여 문제를 해결할 수 있게 되는데, 그중 replication에 대해 알아보겠습니다.

![image](https://github.com/CodeSquad-2023-BE-Study/Jpa-Study/assets/66981851/11d72e22-cacb-45a5-97b2-c47086c717d1)

Replication은 1개 이상의 replica 서버가 source 서버와 동기화를 자동으로 유지하는 과정입니다.
(그림에서는 master-slave 관계로 표현하고 있지만 책에서는 이를 source-replica로 표현하고 있습니다.)

복제는 다양한 목적으로 수행이 됩니다.

- 데이터의 백업
  - 사용자가 INSERT/UPDATE/DELETE 같은 DML 쿼리를 source 서버에 수행하였을 때, 변경사항이 생기면 즉시 replica 서버로 변경된 데이터를 전달하게 됩니다. 이러한 과정으로 데이터를 백업할 수 있게 되며, sourcer 서버에 장애가 생겨도 replica 서버를 사용할 수 있게 됩니다.
- DB의 부하분산
  - 사용자의 폭주로 인해 한 대의 DB가 부하를 감당할 수 없을 떄 MySQL의 replication을 이용해 같은 DB 데이터를 여러 대 만들어 부하를 분산할 수 있습니다.
  - 읽기(`SELECT`)를 쿼리는 모두 replica 서버를 이용하고 나머지(`INSERT`, `UPDATE`, `DELETE`) 쿼리는 source 서버를 이용합니다. (대부분의 작업은 `SELECT` 이기 때문입니다.)

## 테이블 락

테이블 락은 개별 테이블 단위로 설정되는 잠금이며 명시적 혹은 묵시적으로 특정 테이블의 락을 획득할 수 있습니다.

## 네임드 락

네임드 락은 `GET_LOCK()` 함수를 이용해 임의의 문자열에 대한 잠금을 설정할 수 있습니다. 이 잠금의 특징은 잠금의 대상이 테이블이나 레코드 혹은 `AUTO_INCREMENT` 와 같은 DB 객체가 아니라는 것입니다. 단순히 사용자가 지정한 문자열(string)에 대해 획득하고 반납하는 잠금입니다.

> https://techblog.woowahan.com/2631/ <br>
> 위 링크를 보면 분산락을 구현하는데 MySQL 네임드 락이 사용된 예를 볼 수 있습니다.

## 메타데이터 락

메타데이터 락은 데이터베이스 객체(테이블이나 뷰 등)의 이름이나 구조를 변경하는 경우 획득하는 잠금입니다. 메타데이터 락은 명시적으로 획득할 수 있는 잠금이 아니고 `RENAME TABLE tab_a TO tab_b`와 같이 테이블의 이름을 변경하는 등의 경우 자동으로 획득하는 잠금입니다.
